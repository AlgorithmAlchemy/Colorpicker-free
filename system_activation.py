#!/usr/bin/env python3
"""
–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è keyboard —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
"""

import sys
import time
import threading
from PySide6.QtWidgets import QApplication, QWidget, QVBoxLayout, QLabel, QPushButton
from PySide6.QtCore import Qt, QTimer, Signal, QObject

try:
    import keyboard
    KEYBOARD_AVAILABLE = True
    print("‚úÖ keyboard –¥–æ—Å—Ç—É–ø–µ–Ω")
except ImportError:
    KEYBOARD_AVAILABLE = False
    print("‚ùå keyboard –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

try:
    import win32api
    import win32con
    WIN32_AVAILABLE = True
    print("‚úÖ win32api –¥–æ—Å—Ç—É–ø–µ–Ω")
except ImportError:
    WIN32_AVAILABLE = False
    print("‚ùå win32api –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")


class SystemActivationHotkeyManager(QObject):
    """–ú–µ–Ω–µ–¥–∂–µ—Ä —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è."""
    
    ctrl_pressed = Signal()
    escape_pressed = Signal()
    
    def __init__(self):
        super().__init__()
        self._running = False
        self._thread = None
        self._activated = False
        
    def start(self):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π."""
        if not KEYBOARD_AVAILABLE:
            return False
            
        if self._running:
            return True
            
        try:
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ—Ç–æ–∫ –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if self._thread and self._thread.is_alive():
                self._running = False
                self._thread.join(timeout=1)
            
            self._running = True
            self._thread = threading.Thread(
                target=self._monitor_hotkeys, daemon=True
            )
            self._thread.start()
            
            # –ñ–¥–µ–º –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
            time.sleep(1.0)
            
            return True
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: {e}")
            self._running = False
            return False
    
    def stop(self):
        """–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥."""
        self._running = False
        if self._thread and self._thread.is_alive():
            self._thread.join(timeout=1)
    
    def _force_system_activation(self):
        """–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è."""
        try:
            print("üîß –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–∞—Ü–∏—é...")
            
            # –û—á–∏—â–∞–µ–º –≤—Å–µ —Ö—É–∫–∏
            keyboard.unhook_all()
            time.sleep(0.2)
            
            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º listener
            if hasattr(keyboard, '_listener'):
                keyboard._listener.start_if_necessary()
            
            # –°–∏–º—É–ª–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
            if WIN32_AVAILABLE:
                # –°–∏–º—É–ª–∏—Ä—É–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∏ –æ—Ç–ø—É—Å–∫–∞–Ω–∏–µ –∫–ª–∞–≤–∏—à
                for _ in range(5):
                    try:
                        # –°–∏–º—É–ª–∏—Ä—É–µ–º –Ω–∞–∂–∞—Ç–∏–µ Ctrl
                        win32api.keybd_event(win32con.VK_CONTROL, 0, 0, 0)
                        time.sleep(0.05)
                        win32api.keybd_event(win32con.VK_CONTROL, 0, win32con.KEYEVENTF_KEYUP, 0)
                        time.sleep(0.05)
                    except Exception:
                        pass
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            for _ in range(10):
                try:
                    keyboard.is_pressed('ctrl')
                    time.sleep(0.1)
                except Exception:
                    pass
            
            # –§–∏–Ω–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
            time.sleep(0.5)
            
            self._activated = True
            print("üîß –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞")
            
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏: {e}")
    
    def _monitor_hotkeys(self):
        """–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π."""
        try:
            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è
            self._force_system_activation()
            
            # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
            keyboard.on_press_key('ctrl', lambda e: self._on_ctrl_pressed())
            keyboard.on_press_key('esc', lambda e: self._on_escape_pressed())
            
            print("‚úÖ –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã (—Å–∏—Å—Ç–µ–º–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è)")
            
            # –î–µ—Ä–∂–∏–º –ø–æ—Ç–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã–º
            while self._running:
                time.sleep(0.05)
                
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: {e}")
        finally:
            try:
                keyboard.unhook_all()
            except Exception:
                pass
    
    def _on_ctrl_pressed(self):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Ctrl."""
        if self._running:
            print("üéØ Ctrl –Ω–∞–∂–∞—Ç! (—Å–∏—Å—Ç–µ–º–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è)")
            self.ctrl_pressed.emit()
    
    def _on_escape_pressed(self):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Escape."""
        if self._running:
            print("üéØ Escape –Ω–∞–∂–∞—Ç! (—Å–∏—Å—Ç–µ–º–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è)")
            self.escape_pressed.emit()


class TestWindow(QWidget):
    """–¢–µ—Å—Ç–æ–≤–æ–µ –æ–∫–Ω–æ."""
    
    def __init__(self):
        super().__init__()
        self.setWindowTitle("–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏")
        self.setGeometry(100, 100, 400, 300)
        
        layout = QVBoxLayout()
        
        # –°—Ç–∞—Ç—É—Å
        self.status_label = QLabel("–°—Ç–∞—Ç—É—Å: –ê–∫—Ç–∏–≤–∞—Ü–∏—è...")
        layout.addWidget(self.status_label)
        
        # –°—á–µ—Ç—á–∏–∫
        self.ctrl_count = 0
        self.ctrl_label = QLabel("–ù–∞–∂–∞—Ç–∏–π Ctrl: 0")
        layout.addWidget(self.ctrl_label)
        
        # –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
        restart_btn = QPushButton("–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å —Å–∏—Å—Ç–µ–º–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π")
        restart_btn.clicked.connect(self.restart_hotkeys)
        layout.addWidget(restart_btn)
        
        # –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
        close_btn = QPushButton("–ó–∞–∫—Ä—ã—Ç—å")
        close_btn.clicked.connect(self.close)
        layout.addWidget(close_btn)
        
        self.setLayout(layout)
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä
        self.hotkey_manager = SystemActivationHotkeyManager()
        self.hotkey_manager.ctrl_pressed.connect(self._on_ctrl_pressed)
        self.hotkey_manager.escape_pressed.connect(self._on_escape_pressed)
        
        if self.hotkey_manager.start():
            self.status_label.setText("–°—Ç–∞—Ç—É—Å: –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –∞–∫—Ç–∏–≤–Ω—ã")
        else:
            self.status_label.setText("–°—Ç–∞—Ç—É—Å: –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞")
    
    def _on_ctrl_pressed(self):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Ctrl."""
        self.ctrl_count += 1
        self.ctrl_label.setText(f"–ù–∞–∂–∞—Ç–∏–π Ctrl: {self.ctrl_count}")
        print(f"üéØ Ctrl –Ω–∞–∂–∞—Ç! –í—Å–µ–≥–æ: {self.ctrl_count}")
    
    def _on_escape_pressed(self):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Escape."""
        print("üéØ Escape –Ω–∞–∂–∞—Ç! –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ...")
        self.close()
    
    def restart_hotkeys(self):
        """–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏."""
        self.hotkey_manager.stop()
        time.sleep(0.5)
        if self.hotkey_manager.start():
            self.status_label.setText("–°—Ç–∞—Ç—É—Å: –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã")
            print("‚úÖ –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã")
        else:
            self.status_label.setText("–°—Ç–∞—Ç—É—Å: –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞")
            print("‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞")
    
    def closeEvent(self, event):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞."""
        self.hotkey_manager.stop()
        super().closeEvent(event)


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è."""
    app = QApplication(sys.argv)
    
    window = TestWindow()
    window.show()
    
    print("üîß –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∑–∞–ø—É—â–µ–Ω")
    print("üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:")
    print("   - –ù–∞–∂–º–∏—Ç–µ Ctrl –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
    print("   - –ù–∞–∂–º–∏—Ç–µ Escape –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è")
    print("   - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞")
    
    sys.exit(app.exec())


if __name__ == "__main__":
    main()
